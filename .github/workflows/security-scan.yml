# ðŸš¨ GitHub Actions Security Scanning Workflow
# Automated secret detection and security vulnerability scanning

name: ðŸ” Security Scan

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  schedule:
    # Run daily security scans
    - cron: '0 2 * * *'

jobs:
  secret-scanning:
    name: ðŸ” Secret Scanning
    runs-on: ubuntu-latest
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for comprehensive scanning

      - name: ðŸ” TruffleHog OSS Secret Scanner
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          base: main
          head: HEAD
          extra_args: --debug --only-verified

      - name: ðŸ“Š GitLeaks Secret Scanner
        uses: gitleaks/gitleaks@v8.18.0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITLEAKS_LICENSE: ${{ secrets.GITLEAKS_LICENSE }}

  dependency-scanning:
    name: ðŸ—ï¸ Dependency Vulnerability Scan
    runs-on: ubuntu-latest
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ” Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: ðŸ“¦ Install dependencies
        run: npm ci

      - name: ðŸ” npm audit security check
        run: npm audit --audit-level=moderate

      - name: ðŸ” Snyk security scan
        uses: snyk/actions/node@master
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}

  codeql-analysis:
    name: ðŸ§  CodeQL Security Analysis
    runs-on: ubuntu-latest
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ”§ Initialize CodeQL
        uses: github/codeql-action/init@v2
        with:
          languages: javascript, typescript

      - name: ðŸ”§ Autobuild
        uses: github/codeql-action/autobuild@v2

      - name: ðŸ§  Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v2

  secrets-detection:
    name: ðŸ” Custom Secrets Detection
    runs-on: ubuntu-latest
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ðŸ” Custom Secret Pattern Scanner
        run: |
          echo "ðŸ” Scanning for common credential patterns..."
          
          # OpenAI API Keys
          if grep -r "sk-[a-zA-Z0-9]\{48\}" . --exclude-dir=node_modules --exclude-dir=.git; then
            echo "âŒ OpenAI API Key pattern detected!"
            exit 1
          fi
          
          # Google OAuth Client Secrets
          if grep -r "GOCSPX-[a-zA-Z0-9_-]\{28\}" . --exclude-dir=node_modules --exclude-dir=.git; then
            echo "âŒ Google OAuth Client Secret pattern detected!"
            exit 1
          fi
          
          # AWS Access Keys
          if grep -r "AKIA[0-9A-Z]\{16\}" . --exclude-dir=node_modules --exclude-dir=.git; then
            echo "âŒ AWS Access Key pattern detected!"
            exit 1
          fi
          
          # GitHub Personal Access Tokens
          if grep -r "ghp_[a-zA-Z0-9]\{36\}" . --exclude-dir=node_modules --exclude-dir=.git; then
            echo "âŒ GitHub Personal Access Token pattern detected!"
            exit 1
          fi
          
          echo "âœ… No suspicious credential patterns detected."

      - name: ðŸ“Š Upload Security Report
        uses: actions/upload-artifact@v3
        if: always()
        with:
          name: security-scan-report
          path: |
            security-scan-results.json
            gitleaks-report.json

  security-summary:
    name: ðŸ“‹ Security Scan Summary
    runs-on: ubuntu-latest
    needs: [secret-scanning, dependency-scanning, codeql-analysis, secrets-detection]
    if: always()
    steps:
      - name: ðŸ“Š Security Scan Summary
        run: |
          echo "ðŸ” SECURITY SCAN SUMMARY" >> $GITHUB_STEP_SUMMARY
          echo "=========================" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… **Scan Completed**: $(date)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [[ "${{ needs.secret-scanning.result }}" == "success" ]]; then
            echo "âœ… **Secret Scanning**: PASSED" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **Secret Scanning**: FAILED" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [[ "${{ needs.dependency-scanning.result }}" == "success" ]]; then
            echo "âœ… **Dependency Scanning**: PASSED" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **Dependency Scanning**: FAILED" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [[ "${{ needs.codeql-analysis.result }}" == "success" ]]; then
            echo "âœ… **CodeQL Analysis**: PASSED" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **CodeQL Analysis**: FAILED" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [[ "${{ needs.secrets-detection.result }}" == "success" ]]; then
            echo "âœ… **Secrets Detection**: PASSED" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **Secrets Detection**: FAILED" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ” **Security Team**: @security-team" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“§ **Escalation**: security@company.com" >> $GITHUB_STEP_SUMMARY