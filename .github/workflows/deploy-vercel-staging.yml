name: Deploy Staging (Vercel)
on:
  push:
    branches: [develop, staging]

permissions:
  contents: read
  pull-requests: write

jobs:
  staging:
    runs-on: ubuntu-latest
    if: ${{ github.event.repository.fork == false }}
    environment:
      name: Staging
    env:
      VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
      VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
      VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}
      HEALTH_PATH: /api/health
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install deps
        run: npm ci

      - name: Vercel pull (preview env)
        run: vercel pull --yes --environment=preview --token="$VERCEL_TOKEN"

      - name: Vercel build (staging)
        run: vercel build --token="$VERCEL_TOKEN"

      - name: Vercel deploy (staging)
        id: deploy
        run: |
          URL=$(vercel deploy --prebuilt --token="$VERCEL_TOKEN")
          echo "url=${URL}" >> $GITHUB_OUTPUT
          echo "Staging URL: ${URL}"

      - name: Smoke check (health endpoint, retries)
        shell: bash
        run: |
          set -euo pipefail
          url="${{ steps.deploy.outputs.url }}${HEALTH_PATH}"
          echo "Checking $url"
          for i in {1..10}; do
            code=$(curl -s -o /tmp/h -w "%{http_code}" "$url" || true)
            ct=$(curl -sI "$url" | awk 'BEGIN{IGNORECASE=1}/^content-type:/ {print $2}')
            if [ "$code" = "200" ] && [[ "$ct" == application/json* ]]; then
              echo "OK (200 + JSON)"; exit 0
            fi
            echo "Attempt $i failed (code=$code, ct=$ct); retryingâ€¦"; sleep 3
          done
          echo "Health check failed"; cat /tmp/h || true; exit 1

      - name: Comment with Staging URL (de-duped)
        if: ${{ steps.deploy.outputs.url }}
        uses: actions/github-script@v7
        with:
          script: |
            const marker = "<!-- vercel-staging-url -->";
            const url = `${{ toJSON(steps.deploy.outputs.url) }}`;
            const body = `${marker}\nðŸš€ Staging deployed: **${url}**`;
            const {owner, repo} = context.repo;
            const ref = context.ref.split('/').slice(-1)[0];
            const issue_number = (context.payload.pull_request && context.payload.pull_request.number) || null;
            if (!issue_number) { core.notice(`No PR to comment on (branch=${ref}).`); return; }
            const comments = await github.paginate(github.rest.issues.listComments, {owner, repo, issue_number, per_page: 100});
            const existing = comments.find(c => c.body && c.body.includes(marker));
            if (existing) await github.rest.issues.updateComment({owner, repo, comment_id: existing.id, body});
            else await github.rest.issues.createComment({owner, repo, issue_number, body});
